{% extends 'base.html' %}
{% set page_name = 'dashboard' %}
{% block title %}Dashboard{% endblock %}
{% from "render_form_macro.html" import render_form with context %}
{% block content %}
    {% include 'navbar.html' %}
    <div class='container'>
        <div class='col m-4'>
            <div class='row'>
                <div class='col text-center m-4'>
                    {% if request_count is not none %}
                        <p class='counter display-2' data-count='{{ request_count }}' format='regular'>0</p>
                    {% else %}
                        <p class='display-2'>None</p>
                    {% endif %}
                    <h3 class='fade-in-header'>Requests Made to S3 Server</h3>
                </div>
                <div class='col'>
                    <div class='text-center m-4'>
                        {% if average_object_size is not none %}
                            <p class='counter display-2' data-count='{{ average_object_size }}' format='space'>0</p>
                        {% else %}
                            <p class='display-2'>None</p>
                        {% endif %}
                        <h3 class='fade-in-header'>Average object size</h3>
                    </div>
                </div>
            </div>
            {% if not is_default %}
                <hr>
                <div class='row'>
                    <div class='col text-center'>
                        <p class='lead mb-0'>From {{ start_time.strftime('%m/%d/%Y') }}
                            to {{ end_time.strftime('%m/%d/%Y') }}</p>
                    </div>
                </div>
            {% endif %}
            <hr>
            <div class='row m-4'>
                {% if time_info_counts is not none %}
                    <canvas class='m-4 chart' id='time-chart' style='width: 100%; height: 50vh'></canvas>
                {% endif %}
                {% if most_queried_data is not none %}
                    <canvas class='m-4 chart' id='most-queried-chart' style='width: 100%; height: 50vh'></canvas>
                {% endif %}
            </div>
            {% if most_queried_table is not none %}
                <div class='row m-4'>
                    <div class='col text-center'>
                        <h1>Most accessed files</h1>
                    </div>
                    <table class='table table-striped mt-4'>
                        <tr>
                            <th scope='col'>#</th>
                            <th scope='col'>Item</th>
                            <th scope='col'>Experiment</th>
                            <th scope='col'>Assay Type</th>
                            <th scope='col'>Count</th>
                            <th scope='col'>Details</th>
                        </tr>
                        {% for most_queried in most_queried_table %}
                            <tr>
                                {% set name = render_s3_key(most_queried['s3_key']) %}
                                <th scope='row'>{{ loop.index }}</th>
                                <td>
                                    <a target='_blank'
                                       href='{{ get_encode_url('files/' + name.split('.')[0]) }}'>{{ name }}
                                        <span class='ml-2 oi oi-external-link' aria-hidden='true'></span>
                                    </a>
                                </td>
                                <td>
                                    <a target='_blank'
                                       href='{{ get_encode_url('experiments/' + most_queried.experiment) }}'>
                                        {{ most_queried.experiment }}
                                        <span class='ml-2 oi oi-external-link' aria-hidden='true'></span>
                                    </a>
                                </td>
                                <td>{{ most_queried.assay_title }}</td>
                                <td>{{ most_queried.query_count }}</td>
                                <td>
                                    <a id='btn-{{ name }}'
                                            {% if is_default %}
                                       href='{{ url('dashboard:item_dashboard', kwargs={'item_name':name}) }}'
                                            {% else %}
                                       href='{{ url('dashboard:item_dashboard_range', kwargs={'item_name':name, 'start_time':start_time, 'end_time':end_time}) }}'
                                            {% endif %}
                                    >
                                        Details
                                        <span class='ml-2 oi oi-bar-chart' aria-hidden='true'></span>
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}
                    </table>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}
{% block scripts %}
    <script>
        $(document).ready(function () {
            {% if most_queried_data is not none %}
                new Chart($('#most-queried-chart')[0].getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: {{ most_queried_labels|safe }},
                        datasets: [{
                            label: '# of hits',
                            data: {{ most_queried_data|safe }},
                            backgroundColor: chartBackgroundColors,
                            borderColor: chartLineColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        animation: {
                            duration: 5000
                        },
                        onClick: function (event, otherEvent) {
                            const index = otherEvent[0]._index;
                            if (index !== undefined) {
                                label = this.config.data.labels[index];
                                document.getElementById('btn-' + label).click();
                            }
                        }
                    }
                });
            {% endif %}

            {% if time_info_counts is not none %}
                new Chart($('#time-chart')[0].getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: {{ time_info_times|safe }},
                        datasets: [{
                            label: '# of hits',
                            data: {{ time_info_counts|safe }},
                            backgroundColor: getChartBackgroundColor(0),
                            borderColor: getChartLineColor(0),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        animation: {
                            duration: 4000
                        },
                        scales: {
                            xAxes: [{
                                type: 'time',
                                time: {
                                    unit: 'day'
                                }
                            }]
                        }
                    }
                });
            {% endif %}

            $('.fade-in-header').fadeTo(0, 0).delay(1000).fadeTo(500, 1);
            $('.chart').fadeTo(0, 0).delay(1000).fadeTo(500, 1);
        });
    </script>
{% endblock %}