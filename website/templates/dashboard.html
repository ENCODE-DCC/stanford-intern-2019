{% extends 'base.html' %}
{% set page_name = 'dashboard' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
    {% include 'navbar.html' %}
    <div class='container'>
        <div class='col m-4'>
            <div class='row'>
                <div class='col text-center m-4'>
                    <p class='counter display-2' data-count='{{ request_count }}' format='regular'>0</p>
                    <h3 class='fade-in-header'>Requests Made to S3 Server</h3>
                </div>
                <div class='col'>
                    <div class='text-center m-4'>
                        <p class='counter display-2' data-count='{{ average_object_size }}' format='space'>0</p>
                        <h3 class='fade-in-header'>Average object size</h3>
                    </div>
                </div>
            </div>
            <hr>
            <div class='row m-4'>
                <div class='m-4 chart' id='time-chart' style='width: 100%; height: 60vh'></div>
                <div class='m-4 chart' id='most-queried-chart' style='width: 100%; height: 60vh'></div>
            </div>
            <div class='row m-4'>
                <div class='col text-center'>
                    <h1>Most accessed files</h1>
                </div>
                <table class='table mt-4'>
                    <tr>
                        <th scope='col'>Item</th>
                        <th scope='col'>Experiment</th>
                        <th scope='col'>Assay Type</th>
                        <th scope='col'>Count</th>
                        <th scope='col'>Details</th>
                    </tr>
                    {% for most_queried in most_queried_table %}
                        <tr>
                            {% set name = render_s3_key(most_queried.item.s3_key) %}
                            <td><a target='_blank' href='{{ get_encode_url(name.split('.')[0]) }}'>{{ name }}</a></td>
                            <td>
                                <a target='_blank'
                                   href='{{ get_encode_url('experiments/' + most_queried.item.experiment) }}'>
                                    {{ most_queried.item.experiment }}
                                </a>
                            </td>
                            <td>{{ most_queried.item.assay_title }}</td>
                            <td>{{ most_queried.count }}</td>
                            <td>
                                <a id='btn-{{ name }}'
                                   href='{{ url('dashboard:item_dashboard', kwargs={'item_name':name}) }}'>
                                    Details
                                    <span class='ml-2 oi oi-bar-chart' aria-hidden='true'></span>
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    <script>
        Plotly.newPlot('most-queried-chart', [{
                x: {{ most_queried_labels|safe }},
                y: {{ most_queried_data|safe }},
                marker: {
                    color: chartBackgroundColors,
                    line: {
                        color: chartLineColors,
                        width: 1
                    }
                },
                type: 'bar'
            }], {
                title: 'Most accessed files',
                xaxis: {
                    title: 'File'
                }, yaxis: {
                    title: 'Request count'
                }
            }
        );

        Plotly.newPlot('time-chart', [{
                x: {{ time_info_times|safe }},
                y: {{ time_info_counts|safe }},
                type: 'scatter',
                line: {
                    shape: 'spline',
                    color: getChartLineColor(1)
                },
                fill: 'tozeroy',
                fillcolor: getChartBackgroundColor(1)
            }], {
                title: 'Accesses over time',
                xaxis: {
                    title: 'Timestamp'
                }, yaxis: {
                    title: 'Request count'
                }
            }
        );

        $('.fade-in-header').fadeTo(0, 0).delay(1000).fadeTo(500, 1);
        $('.chart').fadeTo(0, 0).delay(1000).fadeTo(500, 1);

        $('#most-queried-chart')[0].on('plotly_click', function (data) {
            const item_name = data.points[0].x;
            const button_id = 'btn-' + item_name;
            document.getElementById(button_id).click()
        });
    </script>
{% endblock %}